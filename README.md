分支跳转：

JAL, JALR, BEQ, BNE, BLT, BGE, BLTU, BGEU 共8条。

一定跳转：JAL, JALR 其他的不一定跳转， 且这两条需要执行WB操作。



Load & Store指令：

LB, LH, LW, LBU, LHU, SB, SH, SW 共8条。

其中：LB, LH, LW, LBU, LHU从内存中读到寄存器中，需要WB操作。

而，SB, SH, SW是写入内存操作， 不需要WB。



计算指令：

其他的21条指令：

都需要WB指令。



需要WB的：计算指令的21条， Load & Store指令中的5条， 分支跳转中的2条， 共28条。

分别是：JAL, JALR, LB, LH, LW, LBU, LHU, LUI, AUIPC, ADDI, SLTI, SLTIU, XORI, ORI, ANDI, SLLI, SRLI, SRAI, ADD, SUB, SLL, SLT, SLTU, XOR, SRL, SRA, OR, AND;



解决控制冒险：执行完某一指令的ID操作后，如果发现是分支跳转指令，则无脑在它后面加一个NOP指令即可(没加分支预测前的暴力操作)。因为EXE阶段就会跳转pc地址，加一个NOP就可以使该条指令的EXE先于下一条指令的IF执行，保证正确性。

解决数据冲突：数据冲突分为两种：1.位于内存的数据冲突（前一操作的MEM对后一条的IF操作产生影响），2.位于寄存器的数据冲突（前一指令的WB操作对后一指令的ID操作发生冲突）。

对于内存中的数据冲突：因为在前一指令的ID阶段就知道是否需要向内存中写入字节、向哪些位置写入字节（注意，这时下一指令还未进行IF操作，所以就可以在上一指令的ID结束后，向事件队列中插入两个NOP，让下一指令的IF操作在上一指令的MEM操作结束后进行即可）。

对于寄存器中的数据冲突：最快在当前指令的ID阶段才能知道是否发生数据冲突（即当前指令的源寄存器是前面若干指令的目的寄存器），而且只需要找前面最近的指令即可。

关于分支预测：每一个类都开一个二位饱和计数器，然后根据每一类branch指令来预测跳转结果（实现过程有很多细节，具体参考代码注释）。

下表是CPU的相关性能和分支预测的效率（JAL和JALR也被算作分支预测中，所以实际的分支预测成功率应该比下表要低）：

|   test name    | CPU cycles | 分支预测数 | 分支预测成功率(%) |
| :------------: | :--------: | :--------: | :---------------: |
|  array_test1   |    303     |     44     |       77.27       |
|  array_test2   |    369     |     50     |        78         |
|   basicopt1    |   671647   |   190750   |      73.7992      |
|   bulgarian    |   692922   |   91458    |      82.194       |
|      expr      |    599     |    123     |      85.3659      |
|      gcd       |    605     |    171     |      76.0234      |
|     hanoi      |   359319   |   28207    |      81.813       |
|    lvalue2     |     63     |     14     |      85.7143      |
|     magic      |  1193311   |   89279    |      64.9974      |
| manyarguments  |     75     |     18     |      77.7778      |
|   multiarray   |    2813    |    261     |      87.3563      |
|     naive      |     41     |     4      |        100        |
|       pi       | 112476341  |  42208788  |      79.5031      |
|     qsort      |  2299838   |   268671   |      83.9383      |
|     queens     |  1130187   |   99701    |      73.0815      |
| statement_test |    1520    |    280     |      68.2143      |
|   superloop    |   604072   |   445087   |      79.3034      |
|      tak       |  4317122   |   197071   |      93.8499      |

